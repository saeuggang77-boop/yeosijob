name: Cron Jobs

on:
  schedule:
    # 자동점프 - 매 10분 (GitHub Actions 최소 5분)
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  auto-jump:
    runs-on: ubuntu-latest
    steps:
      - name: Auto Jump
        run: |
          curl -s -X GET "https://yeosijob.com/api/cron/auto-jump" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"

  reset-manual-jump:
    runs-on: ubuntu-latest
    # 매일 자정 KST (15:00 UTC)
    if: github.event.schedule == '*/10 * * * *' && false
    steps:
      - run: echo "skip"

  hourly-jobs:
    runs-on: ubuntu-latest
    steps:
      - name: Check minute
        id: check
        run: |
          MINUTE=$(date -u +%M)
          HOUR=$(date -u +%H)
          echo "minute=$MINUTE" >> $GITHUB_OUTPUT
          echo "hour=$HOUR" >> $GITHUB_OUTPUT

      # 매시간 정각 - 광고 만료 처리
      - name: Expire Ads
        if: steps.check.outputs.minute == '00'
        run: |
          curl -s -X GET "https://yeosijob.com/api/cron/expire-ads" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"

      # 매 3시간 - 조회수 자연 증가
      - name: Boost Views
        if: steps.check.outputs.minute == '00' && contains('00,03,06,09,12,15,18,21', steps.check.outputs.hour)
        run: |
          curl -s -X GET "https://yeosijob.com/api/cron/boost-views" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"

      # 매 6시간 - 입금 대기 만료
      - name: Expire Pending
        if: steps.check.outputs.minute == '00' && contains('00,06,12,18', steps.check.outputs.hour)
        run: |
          curl -s -X GET "https://yeosijob.com/api/cron/expire-pending" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"

      # 매일 15:00 UTC (자정 KST) - 수동점프 리셋
      - name: Reset Manual Jump
        if: steps.check.outputs.minute == '00' && steps.check.outputs.hour == '15'
        run: |
          curl -s -X GET "https://yeosijob.com/api/cron/reset-manual-jump" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"

      # 매일 00:00 UTC (09:00 KST) - 만료 알림
      - name: Notify Expiry
        if: steps.check.outputs.minute == '00' && steps.check.outputs.hour == '00'
        run: |
          curl -s -X GET "https://yeosijob.com/api/cron/notify-expiry" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"

      # 매일 03:00 UTC (12:00 KST) - 만료 본인인증 토큰 정리
      - name: Cleanup Age Tokens
        if: steps.check.outputs.minute == '00' && steps.check.outputs.hour == '03'
        run: |
          curl -s -X GET "https://yeosijob.com/api/cron/cleanup-age-tokens" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"
