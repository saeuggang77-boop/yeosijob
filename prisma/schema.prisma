generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ── ENUMS ──

enum UserRole {
  JOBSEEKER
  BUSINESS
  ADMIN
}

enum AdStatus {
  DRAFT
  PENDING_PAYMENT
  PENDING_DEPOSIT
  PENDING_REVIEW
  ACTIVE
  PAUSED
  EXPIRED
  REJECTED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  APPROVED
  FAILED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CARD
  BANK_TRANSFER
  KAKAO_PAY
  FREE_CREDIT
}

enum AdProductId {
  FREE
  LINE
  RECOMMEND
  URGENT
  SPECIAL
  PREMIUM
  VIP
  BANNER
}

enum AdOptionId {
  BOLD
  ICON
  HIGHLIGHT
  KAKAO_ALERT
}

enum JumpType {
  AUTO
  MANUAL
}

enum GhostPersonality {
  CHATTY
  ADVISOR
  QUESTIONER
  EMOJI_LOVER
  CALM
  SASSY
}

enum ContentType {
  POST
  COMMENT
  REPLY
}

enum ReportReason {
  ABUSE
  OBSCENE
  SPAM
  PRIVACY
  OTHER
}

enum ReportStatus {
  PENDING
  RESOLVED
  DISMISSED
}

enum BusinessType {
  KARAOKE
  ROOM_SALON
  TEN_CAFE
  SHIRT_ROOM
  LEGGINGS_ROOM
  PUBLIC_BAR
  HYPER_PUBLIC
  BAR_LOUNGE
  CLUB
  MASSAGE
  GUANRI
  OTHER
}

enum Region {
  SEOUL
  GYEONGGI
  INCHEON
  BUSAN
  DAEGU
  DAEJEON
  GWANGJU
  ULSAN
  SEJONG
  GANGWON
  CHUNGBUK
  CHUNGNAM
  JEONBUK
  JEONNAM
  GYEONGBUK
  GYEONGNAM
  JEJU
}

// ── AUTH ──

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@unique([email, token])
  @@map("password_reset_tokens")
}

// ── USER ──

model User {
  id             String   @id @default(cuid())
  name           String?
  email          String?  @unique
  emailVerified  DateTime?
  image          String?
  phone          String?  @unique
  hashedPassword String?
  role           UserRole @default(JOBSEEKER)

  // 업소 사장님 전용
  businessName   String?
  businessNumber String?
  isVerifiedBiz  Boolean  @default(false)
  freeAdCredits  Int      @default(0)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 본인인증
  ageVerified    DateTime?

  // 유령회원
  isGhost          Boolean          @default(false)
  ghostPersonality GhostPersonality?

  accounts         Account[]
  sessions         Session[]
  ads              Ad[]
  payments         Payment[]
  resumes          Resume[]
  reviews          Review[]
  scraps           Scrap[]
  jumpLogs         JumpLog[]
  notifications    Notification[]
  resumeViews      ResumeViewLog[] @relation("resumeViews")
  posts            Post[]
  comments         Comment[]
  notices          Notice[]
  ageVerifications AgeVerification[]
  reports          Report[]
  sentMessages     Message[] @relation("sentMessages")
  receivedMessages Message[] @relation("receivedMessages")
  pushSubscriptions PushSubscription[]

  @@index([role])
  @@index([isGhost])
  @@map("users")
}

// ── AGE VERIFICATION (본인인증) ──

model AgeVerification {
  id        String   @id @default(cuid())
  token     String   @unique
  name      String
  birthDate String
  phone     String
  carrier   String?
  impUid    String   @unique
  userId    String?
  verified  Boolean  @default(true)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([token])
  @@index([expiresAt])
  @@map("age_verifications")
}

// ── AD (광고 = 채용공고) ──

model Ad {
  id     String @id @default(cuid())
  userId String

  // 업소 정보
  businessName String
  businessType BusinessType
  contactPhone String
  contactKakao String?

  // 채용 조건
  title       String
  description String  @db.Text
  salaryText  String
  workHours   String?
  benefits    String? @db.Text

  // 위치
  regions       Region[]
  address       String?
  addressDetail String?

  // 광고 상품
  productId    AdProductId
  durationDays Int
  totalAmount  Int

  // 노출 상태
  status    AdStatus  @default(DRAFT)
  startDate DateTime?
  endDate   DateTime?

  // 점프 시스템
  autoJumpPerDay      Int      @default(0)
  manualJumpPerDay    Int      @default(0)
  manualJumpUsedToday Int      @default(0)
  lastJumpedAt        DateTime @default(now())
  lastManualJumpAt    DateTime?

  // 이미지
  imageUrl     String?
  thumbnailUrl String?

  // 통계
  viewCount  Int @default(0)
  clickCount Int @default(0)

  // 수정
  editCount Int @default(0)
  maxEdits  Int @default(1)

  // 인증
  isVerified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User            @relation(fields: [userId], references: [id])
  options      AdOption[]
  payments     Payment[]
  jumpLogs     JumpLog[]
  reviews      Review[]
  scraps       Scrap[]
  dailyMetrics AdDailyMetric[]

  @@index([status, lastJumpedAt(sort: Desc)])
  @@index([status, productId])
  @@index([userId])
  @@index([businessType])
  @@index([startDate, endDate])
  @@index([status, productId, lastJumpedAt(sort: Desc)])
  @@index([status, regions])
  @@map("ads")
}

model AdOption {
  id           String     @id @default(cuid())
  adId         String
  optionId     AdOptionId
  value        String?
  durationDays Int
  startDate    DateTime?
  endDate      DateTime?
  createdAt    DateTime   @default(now())
  ad           Ad         @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@index([adId])
  @@map("ad_options")
}

// ── PAYMENT ──

model Payment {
  id     String  @id @default(cuid())
  userId String
  adId   String?

  orderId String        @unique
  amount  Int
  method  PaymentMethod
  status  PaymentStatus @default(PENDING)

  // Toss
  tossPaymentKey String? @unique
  cardCompany    String?
  cardNumber     String?
  receiptUrl     String?

  // 무통장
  bankName      String?
  accountNumber String?
  depositorName String?

  // 상품 내역 스냅샷
  itemSnapshot Json

  // 세금계산서
  taxInvoice   Boolean @default(false)
  taxBizNumber String?

  paidAt       DateTime?
  failedAt     DateTime?
  failReason   String?
  refundedAt   DateTime?
  refundAmount Int?
  refundReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  ad   Ad?  @relation(fields: [adId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

// ── JUMP ──

model JumpLog {
  id       String   @id @default(cuid())
  adId     String
  userId   String
  type     JumpType
  jumpedAt DateTime @default(now())
  ad       Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id])

  @@index([adId, jumpedAt])
  @@map("jump_logs")
}

// ── RESUME (구직자 이력서) ──

model Resume {
  id           String         @id @default(cuid())
  userId       String         @unique

  // 기본정보
  nickname     String
  gender       String         @default("여성")
  age          Int
  height       Int?
  weight       Int?

  // 희망 근무지역
  region       Region
  districts    String[]

  // 희망 업종/경력/급여
  desiredJobs        BusinessType[]
  experienceLevel    String         @default("BEGINNER")
  desiredSalaryType  String?
  desiredSalaryAmount Int?
  availableHours     String?

  // 연락처
  kakaoId      String         @default("")
  phone        String?

  // 이력서 내용
  title        String         @default("")
  introduction String         @db.Text @default("")
  photoUrl     String?

  // 공개
  isPublic        Boolean   @default(true)
  lastBumpedAt    DateTime?

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  viewLogs     ResumeViewLog[]

  @@index([region])
  @@index([isPublic, lastBumpedAt(sort: Desc)])
  @@index([isPublic, createdAt])
  @@index([isPublic, region])
  @@map("resumes")
}

// ── REVIEW (업소 후기) ──

model Review {
  id        String   @id @default(cuid())
  adId      String
  userId    String
  rating    Int
  content   String   @db.Text
  isHidden  Boolean  @default(false)
  createdAt DateTime @default(now())
  ad        Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@unique([adId, userId])
  @@index([adId])
  @@map("reviews")
}

// ── SCRAP (스크랩/찜) ──

model Scrap {
  id        String   @id @default(cuid())
  userId    String
  adId      String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ad        Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@unique([userId, adId])
  @@index([userId])
  @@map("scraps")
}

// ── 통계 ──

model AdDailyMetric {
  id     String   @id @default(cuid())
  adId   String
  date   DateTime @db.Date
  views  Int      @default(0)
  clicks Int      @default(0)
  ad     Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@unique([adId, date])
  @@map("ad_daily_metrics")
}

// ── NOTIFICATION ──

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String   @db.Text
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

// ── RESUME VIEW LOG ──

model ResumeViewLog {
  id        String   @id @default(cuid())
  userId    String
  resumeId  String
  adId      String?
  viewedAt  DateTime @default(now())
  user      User     @relation("resumeViews", fields: [userId], references: [id])
  resume    Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@index([userId, viewedAt])
  @@index([resumeId])
  @@map("resume_view_logs")
}

// ── COMMUNITY (자유수다 게시판) ──

model Post {
  id        String   @id @default(cuid())
  title     String
  content   String   @db.Text
  category  String   @default("CHAT")
  authorId  String
  viewCount Int      @default(0)
  isHidden  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author       User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments     Comment[]
  contentPools ContentPool[]
  reports      Report[]

  @@index([category, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([authorId])
  @@map("posts")
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  authorId  String
  postId    String
  parentId  String?
  createdAt DateTime @default(now())

  author  User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  post    Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies Comment[] @relation("CommentReplies")
  reports Report[]

  @@index([postId, createdAt(sort: Desc)])
  @@index([authorId])
  @@index([parentId])
  @@map("comments")
}

// ── REPORT (신고) ──

model Report {
  id         String       @id @default(cuid())
  reporterId String
  postId     String?
  commentId  String?
  reason     ReportReason
  detail     String?      @db.Text
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())

  reporter User     @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  post     Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment  Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([reporterId, postId])
  @@unique([reporterId, commentId])
  @@index([status])
  @@map("reports")
}

// ── CONTENT POOL (자동 콘텐츠) ──

model ContentPool {
  id              String           @id @default(cuid())
  type            ContentType
  personality     GhostPersonality
  title           String?
  content         String           @db.Text
  category        String?
  isUsed          Boolean          @default(false)
  publishedPostId String?
  createdAt       DateTime         @default(now())

  publishedPost Post? @relation(fields: [publishedPostId], references: [id], onDelete: SetNull)

  @@index([type, personality, isUsed])
  @@index([type, isUsed])
  @@index([publishedPostId])
  @@map("content_pool")
}

// ── AUTO CONTENT CONFIG ──

model AutoContentConfig {
  id                String   @id @default("singleton")
  enabled           Boolean  @default(false)
  postsPerDay       Int      @default(8)
  commentsPerPost   Int      @default(3)
  repliesPerComment Int      @default(1)
  activeStartHour   Int      @default(14)
  activeEndHour     Int      @default(4)
  realPostAutoReply Boolean  @default(true)
  monthlyBudgetKrw  Int      @default(100000)
  seoKeywords       String[] @default([])
  seoKeywordUsage   Json?    @default("{}")
  updatedAt         DateTime @updatedAt

  @@map("auto_content_config")
}

// ── AI USAGE LOG ──

model AiUsageLog {
  id               String   @id @default(cuid())
  model            String
  inputTokens      Int
  outputTokens     Int
  estimatedCostKrw Int
  context          String?
  createdAt        DateTime @default(now())

  @@index([createdAt])
  @@map("ai_usage_logs")
}

// ── NOTICE (공지사항) ──

model Notice {
  id        String   @id @default(cuid())
  title     String
  content   String   @db.Text
  authorId  String
  viewCount Int      @default(0)
  isPinned  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([isPinned(sort: Desc), createdAt(sort: Desc)])
  @@map("notices")
}

// ── MESSAGE (쪽지/DM) ──

model Message {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  content    String   @db.Text
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  sender   User @relation("sentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("receivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([receiverId, isRead])
  @@index([senderId])
  @@index([receiverId, senderId])
  @@map("messages")
}

// ── PUSH SUBSCRIPTION ──

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String   @db.Text
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([userId])
  @@map("push_subscriptions")
}
